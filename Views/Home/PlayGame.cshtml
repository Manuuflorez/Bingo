@model Bingoo.Models.Room

<h2>Sala de Bingo - Sala: @Model.Owner</h2>

<!-- Sección para mostrar los usuarios conectados -->
<h3>Usuarios Conectados</h3>
<ul id="usersList">
    <!-- Aquí se mostrará la lista de usuarios conectados -->
</ul>

<div id="game-board">
    <h3>Velocidad del lanzamiento de balotas: @Model.Speed segundos</h3>
    <form asp-action="LeaveGame" method="post">
        <input type="hidden" name="id" value="@Model.Id" />
        <button type="submit" class="btn btn-danger">Salir de la Sala</button>
    </form>

    <!-- Tablero de Bingo -->
    <div id="bingo-board" class="board">
        <table id="bingo-table" class="bingo-table">
            <thead>
                <tr>
                    <th>B</th>
                    <th>I</th>
                    <th>N</th>
                    <th>G</th>
                    <th>O</th>
                </tr>
            </thead>
            <tbody id="bingo-body">
                <!-- Filas del tablero de Bingo -->
            </tbody>
        </table>
    </div>

    <div id="ball-drawer">
        <p id="current-ball">Balota actual: -</p>
    </div>

    <!-- Botón de Pausa/Reanudar y Sacar balotas dependiendo del tipo de lanzamiento -->
    @if (Model.MarkingType == "automatic")
    {
        <p>El juego se iniciará automáticamente con la velocidad seleccionada.</p>
        <button class="btn btn-success" id="start-game-btn">Iniciar Juego</button>
        <button class="btn btn-warning" id="pause-game-btn" style="display:none;">Pausar</button>
    }

    @if (Model.MarkingType == "manual")
    {
        <div>
            <p>Saca las balotas manualmente haciendo clic en el botón a continuación.</p>
            <button class="btn btn-primary" id="draw-ball-btn">Sacar una Balota</button>
        </div>
    }
</div>

<!-- Estilos personalizados para el tablero de Bingo -->
<style>
    .bingo-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .bingo-table th,
    .bingo-table td {
        border: 2px solid #000;
        text-align: center;
        padding: 15px;
        font-size: 20px;
        width: 50px;
        height: 50px;
    }

    .bingo-table th {
        background-color: #f0f0f0;
        font-size: 22px;
    }

    .bingo-cell {
        background-color: #ffffff;
        color: #333;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .bingo-cell.marked {
        background-color: #4CAF50;
        color: #fff;
        font-weight: bold;
    }

    .bingo-cell:hover {
        background-color: #ddd;
    }

    .bingo-cell-free {
        background-color: #FFA500;
        color: #fff;
        font-weight: bold;
    }

    #current-ball {
        margin-top: 20px;
        font-size: 24px;
        font-weight: bold;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.9/signalr.min.js"></script>

<script>
    let gameInterval;
    let isPaused = false;
    const autoMarking = '@Model.AutoMarking';  // Marcar automáticamente o no

    // Crear una conexión con SignalR al Hub
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/bingohub")
        .build();

    const roomId = "@Model.Id";
    const userName = "@(User.Identity?.Name ?? "Invitado")";

    // Conectar al hub cuando la página esté lista
    connection.start().then(function() {
        // Unirse a la sala
        connection.invoke("JoinRoom", roomId, userName);
    });

    // Manejar la actualización de la lista de usuarios cuando alguien se une
    connection.on("UserJoined", function(userName) {
        const userList = document.getElementById("usersList");
        const newUser = document.createElement("li");
        newUser.textContent = userName;
        newUser.id = userName;
        userList.appendChild(newUser);
    });

    // Manejar la eliminación de un usuario de la lista cuando alguien se va
    connection.on("UserLeft", function(userName) {
        const userElement = document.getElementById(userName);
        if (userElement) {
            userElement.remove();
        }
    });

    // Actualizar la lista de usuarios conectados en tiempo real
    connection.on("UpdateUserList", function(users) {
        const userList = document.getElementById("usersList");
        userList.innerHTML = ''; // Limpiar la lista de usuarios

        // Recorrer la lista de usuarios y añadirlos a la lista visual
        users.forEach(function(user) {
            const newUser = document.createElement("li");
            newUser.textContent = user;
            newUser.id = user;
            userList.appendChild(newUser);
        });
    });

    // Salir de la sala cuando se cierre la página
    window.addEventListener("beforeunload", function () {
        connection.invoke("LeaveRoom", roomId, userName);
    });

    // Generar el tablero de Bingo con números aleatorios
    function generateBingoBoard() {
        const bingoBoard = document.getElementById('bingo-body');
        bingoBoard.innerHTML = '';

        const columns = {
            B: generateUniqueNumbers(1, 15),
            I: generateUniqueNumbers(16, 30),
            N: generateUniqueNumbers(31, 45),
            G: generateUniqueNumbers(46, 60),
            O: generateUniqueNumbers(61, 75)
        };

        for (let i = 0; i < 5; i++) {
            const row = document.createElement('tr');

            Object.keys(columns).forEach(col => {
                const cell = document.createElement('td');
                cell.classList.add('bingo-cell');

                // Colocar la casilla central "FREE" en la columna "N"
                if (col === 'N' && i === 2) {
                    cell.textContent = 'FREE';
                    cell.classList.add('bingo-cell-free'); // Casilla FREE con estilo especial
                } else {
                    cell.textContent = columns[col][i];
                }
                row.appendChild(cell);
            });

            bingoBoard.appendChild(row);
        }

        // Añadir evento para marcar manualmente si no es autoMarking
        if (autoMarking === 'no') {
            addManualMarkingListeners();
        }
    }

    // Añadir eventos a las celdas para marcación manual
    function addManualMarkingListeners() {
        const cells = document.querySelectorAll('.bingo-cell');
        cells.forEach(cell => {
            cell.addEventListener('click', function () {
                const currentBall = parseInt(document.getElementById('current-ball').textContent.split(": ")[1]);
                if (parseInt(cell.textContent) === currentBall) {
                    cell.classList.add('marked');
                }
            });
        });
    }

    // Generar un conjunto de números únicos dentro de un rango
    function generateUniqueNumbers(min, max) {
        const numbers = [];
        while (numbers.length < 5) {
            const num = Math.floor(Math.random() * (max - min + 1)) + min;
            if (!numbers.includes(num)) {
                numbers.push(num);
            }
        }
        return numbers;
    }

    // Lógica para iniciar el juego automáticamente si el lanzamiento es automático
    if ('@Model.MarkingType' === 'automatic') {
        document.getElementById('start-game-btn').addEventListener('click', function () {
            const generatorType = '@Model.GeneratorType';
            const speed = @Model.Speed * 1000;  // Convertimos los segundos a milisegundos

            // Mostrar inmediatamente la primera balota
            drawBall(generatorType);

            // Iniciar el juego con intervalo basado en la velocidad seleccionada después de la primera balota
            gameInterval = setInterval(function () {
                drawBall(generatorType);
            }, speed);  // Usamos la velocidad configurada por el usuario

            // Cambiar el botón de inicio a pausa
            document.getElementById('start-game-btn').style.display = 'none';
            document.getElementById('pause-game-btn').style.display = 'inline-block';
        });

        // Lógica para pausar y reanudar el juego
        document.getElementById('pause-game-btn').addEventListener('click', function () {
            if (!isPaused) {
                // Pausar el juego
                clearInterval(gameInterval);
                isPaused = true;
                this.textContent = 'Reanudar';
            } else {
                // Reanudar el juego
                const generatorType = '@Model.GeneratorType';
                const speed = @Model.Speed * 1000;  // Convertimos los segundos a milisegundos
                gameInterval = setInterval(function () {
                    drawBall(generatorType);
                }, speed);
                isPaused = false;
                this.textContent = 'Pausar';
            }
        });
    }

    // Lógica para sacar balotas manualmente
    if ('@Model.MarkingType' === 'manual') {
        document.getElementById('draw-ball-btn').addEventListener('click', function () {
            const generatorType = '@Model.GeneratorType';
            drawBall(generatorType);
        });
    }

    // Función para generar y mostrar una balota
    function drawBall(generatorType) {
        const ball = generateRandomNumber(generatorType);
        document.getElementById('current-ball').textContent = "Balota actual: " + ball;

        // Marcar automáticamente si la opción está habilitada
        if (autoMarking === 'yes') {
            markNumberOnBoard(ball);
        }
    }

    // Función que genera un número basado en el tipo de generador seleccionado al crear la sala
    function generateRandomNumber(generatorType) {
        let number;
        switch (generatorType) {
            case '1': // Generador básico
                number = Math.floor(Math.random() * 75) + 1;
                break;
            case '2': // Generador con cálculo diferente
                number = (Math.floor(Math.random() * 75) + 1) * 2 % 75;
                break;
            case '3': // Otro tipo de lógica
                number = Math.ceil(Math.random() * 75);
                break;
            default:
                number = Math.floor(Math.random() * 75) + 1;
                break;
        }
        return number;
    }

    // Función para marcar un número en el tablero de Bingo automáticamente
    function markNumberOnBoard(number) {
        const cells = document.querySelectorAll('.bingo-cell');
        cells.forEach(cell => {
            if (parseInt(cell.textContent) === number) {
                cell.classList.add('marked');
            }
        });
    }

    // Generar el tablero de Bingo cuando la página carga
    window.onload = generateBingoBoard;
</script>

